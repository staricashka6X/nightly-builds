name: Build postmarketOS rootfs

on:
  workflow_dispatch:
  push:

env:
  DEVICE: xiaomi-miatoll
  UI: plasma-mobile
  CHANNEL: edge

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git python3 qemu-user-static proot

      - name: Install pmbootstrap 3.0.0
        run: |
          git clone --depth=1 --branch 3.0.0 https://gitlab.postmarketos.org/postmarketOS/pmbootstrap.git
          mkdir -p ~/.local/bin
          ln -s "$PWD/pmbootstrap/pmbootstrap.py" ~/.local/bin/pmbootstrap
          pmbootstrap --version

      - name: Prepare pmbootstrap environment (manual init)
        run: |
          mkdir -p ~/.local/var/pmbootstrap/cache_git
          mkdir -p ~/.local/var/pmbootstrap/chroot_native
          mkdir -p ~/.local/var/pmbootstrap/chroot_rootfs_${DEVICE}
          mkdir -p ~/.local/var/pmbootstrap/chroot_device_${DEVICE}

          git clone https://gitlab.postmarketos.org/postmarketOS/pmaports.git \
            ~/.local/var/pmbootstrap/cache_git/pmaports

          mkdir -p ~/.config
          cat > ~/.config/pmbootstrap.cfg << EOF
          [pmbootstrap]
          work = /home/runner/.local/var/pmbootstrap
          pmaports = /home/runner/.local/var/pmbootstrap/cache_git/pmaports
          device = ${DEVICE}
          vendor = xiaomi
          ui = ${UI}
          channel = ${CHANNEL}
          systemd = no
          EOF

      - name: Update pmaports
        run: pmbootstrap pull

      - name: Build rootfs
        run: |
          pmbootstrap install --password 1234

      - name: Export rootfs
        run: |
          pmbootstrap export
          mkdir out
          cp /tmp/postmarketOS-export/${DEVICE}-root.img out/rootfs.img

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rootfs-${{ env.DEVICE }}
          path: out/*
          retention-days: 30